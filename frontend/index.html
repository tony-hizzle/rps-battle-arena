<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPS Battle Arena</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            text-align: center;
        }

        header h1 {
            color: white;
            font-size: 2rem;
        }

        main {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 80px);
            padding: 2rem;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .card h2 {
            margin-bottom: 1.5rem;
            color: #333;
            font-size: 1.8rem;
        }

        input {
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 1rem;
        }

        button {
            padding: 1rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.3s;
        }

        .primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .move-btn {
            background: white;
            border: 3px solid #667eea;
            color: #667eea;
            font-size: 1.2rem;
            padding: 1.5rem;
            border-radius: 15px;
            min-width: 120px;
        }

        .move-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .hidden {
            display: none !important;
        }

        .result {
            margin: 1rem 0;
            font-size: 1.1rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
        }

        .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <h1>üéÆ RPS Battle Arena</h1>
    </header>

    <main>
        <div class="card">
            <div id="login-screen">
                <h2>Join the Battle!</h2>
                <div id="auth-options">
                    <p>Sign in to track your wins and compete on the leaderboard!</p>
                    <div style="margin: 2rem 0;">
                        <button class="primary-btn" onclick="showEmailLogin()" style="margin: 0.5rem;">
                            üìß Sign In
                        </button>
                        <button class="primary-btn" onclick="showEmailRegister()" style="margin: 0.5rem;">
                            üÜï Create Account
                        </button>
                    </div>
                    <button onclick="playAsGuest()" style="background: #6c757d; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 10px; font-size: 0.9rem; cursor: pointer; margin: 0.5rem;">
                        Play as Guest
                    </button>
                </div>
                <div id="email-login-form" class="hidden">
                    <input type="email" id="login-email" placeholder="Enter email address" required>
                    <input type="password" id="login-password" placeholder="Enter password" required>
                    <button class="primary-btn" onclick="signInWithEmail()">Sign In</button>
                    <button onclick="showAuthOptions()">Back</button>
                </div>
                <div id="email-register-form" class="hidden">
                    <input type="email" id="reg-email" placeholder="Enter email address" required>
                    <input type="password" id="reg-password" placeholder="Choose password (min 8 characters)" required>
                    <input type="text" id="reg-username" placeholder="Choose display name" required>
                    <button class="primary-btn" onclick="signUpWithEmail()">Create Account</button>
                    <button onclick="showAuthOptions()">Back</button>
                </div>
                <div id="email-verify-form" class="hidden">
                    <h3>Verify Your Email</h3>
                    <p>Please enter the verification code sent to your email address.</p>
                    <input type="text" id="verify-code" placeholder="Enter verification code" required maxlength="6">
                    <button class="primary-btn" onclick="verifyEmail()">Verify</button>
                    <button onclick="resendVerificationCode()">Resend Code</button>
                    <button onclick="showAuthOptions()">Back</button>
                </div>
            </div>

            <div id="mode-screen" class="hidden">
                <h2>Choose Game Mode</h2>
                <p>Playing as: <span id="player-name-mode"></span></p>
                <div>
                    <button class="primary-btn" onclick="selectMode('multiplayer')">üéÆ Find Online Player</button>
                    <button class="primary-btn" onclick="selectMode('computer')">ü§ñ Play vs Computer</button>
                </div>
                <div style="margin-top: 1rem;">
                    <button onclick="showStats()" style="padding: 1rem 2rem; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; margin: 0.5rem;">View Stats</button>
                    <button onclick="logout()" style="background: #dc3545; color: white; padding: 1rem 2rem; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; margin: 0.5rem;">Logout</button>
                </div>
            </div>
            
            <div id="waiting-screen" class="hidden">
                <h2>üîç Finding Player...</h2>
                <p>Searching for an online opponent</p>
                <div class="spinner"></div>
                <div>
                    <button onclick="cancelToMenu()">Cancel</button>
                    <button class="primary-btn" onclick="playComputer()">Play Computer</button>
                </div>
            </div>

            <div id="game-screen" class="hidden">
                <h2>Make Your Move!</h2>
                <p>Playing as: <span id="player-name"></span></p>
                <p id="opponent-info">vs Computer</p>
                <div>
                    <button class="move-btn" onclick="makeMove('rock')">ü™® Rock</button>
                    <button class="move-btn" onclick="makeMove('paper')">üìÑ Paper</button>
                    <button class="move-btn" onclick="makeMove('scissors')">‚úÇÔ∏è Scissors</button>
                </div>
            </div>

            <div id="result-screen" class="hidden">
                <h2 id="result-title"></h2>
                <div class="result">
                    <p>You played: <span id="your-move"></span></p>
                    <p>Opponent played: <span id="opponent-move"></span></p>
                </div>
                <div id="result-buttons">
                    <button class="primary-btn" onclick="playAgain()">Play Again</button>
                    <button onclick="showStats()">View Stats</button>
                    <button onclick="logout()" style="background: #dc3545; color: white;">Logout</button>
                </div>
            </div>

            <div id="stats-screen" class="hidden">
                <h2>Your Statistics</h2>
                <div class="stats">
                    <div class="stat">
                        <span class="stat-value" id="total-games">0</span>
                        <span>Total Games</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="wins">0</span>
                        <span>Wins</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="losses">0</span>
                        <span>Losses</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="draws">0</span>
                        <span>Draws</span>
                    </div>
                </div>
                <button onclick="showGameHistory()" style="min-width: 140px; padding: 1rem 2rem; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; margin: 0.5rem;">Game History</button>
                <button onclick="showLeaderboard()" style="min-width: 140px; padding: 1rem 2rem; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; margin: 0.5rem;">Leaderboard</button>
                <button onclick="backToGame()" style="min-width: 140px; padding: 1rem 2rem; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; margin: 0.5rem;">Back to Game</button>
                <button onclick="logout()" style="background: #dc3545; color: white; min-width: 140px; padding: 1rem 2rem; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; margin: 0.5rem;">Logout</button>
            </div>
            
            <div id="history-screen" class="hidden">
                <h2>Game History</h2>
                <div id="game-history"></div>
                <button onclick="showStats()">Back to Stats</button>
            </div>
            
            <div id="leaderboard-screen" class="hidden">
                <h2>üèÜ Leaderboard</h2>
                <div id="leaderboard-list"></div>
                <button onclick="showStats()">Back to Stats</button>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
    <script>
        const API_URL = 'https://19qwltuxoi.execute-api.us-east-1.amazonaws.com/prod';
        
        // Cognito Configuration
        const COGNITO_CONFIG = {
            userPoolId: 'us-east-1_Zfn7ed9qT',
            clientId: '58f0vvfskgti5qnnr79u9uod7b',
            identityPoolId: 'us-east-1:9b21c277-46ba-4d03-a1d6-098e9ca099f1',
            region: 'us-east-1'
        };
        
        let currentUser = null;
        let gameStats = { totalGames: 0, wins: 0, losses: 0, draws: 0 };
        let gameMode = 'computer';
        let searchTimeout = null;
        let currentGameId = null;
        let gameCheckInterval = null;
        let cognitoUser = null;
        
        // Check for saved login on page load
        window.addEventListener('load', function() {
            const savedUser = localStorage.getItem('rpsUser');
            const savedTokens = localStorage.getItem('cognitoTokens');
            
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('player-name').textContent = currentUser.username;
                    document.getElementById('player-name-mode').textContent = currentUser.username;
                    showScreen('mode-screen');
                    if (!currentUser.isGuest) {
                        loadUserStats();
                    }
                } catch (error) {
                    localStorage.removeItem('rpsUser');
                    localStorage.removeItem('cognitoTokens');
                    showAuthOptions();
                    showScreen('login-screen');
                }
            } else {
                showAuthOptions();
                showScreen('login-screen');
            }
        });

        function showScreen(screenId) {
            console.log('Switching to screen:', screenId);
            document.querySelectorAll('[id$="-screen"]').forEach(screen => {
                screen.classList.add('hidden');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                // Chrome-specific: force reflow to ensure screen change
                targetScreen.offsetHeight;
            } else {
                console.error('Screen not found:', screenId);
            }
        }

        function showAuthOptions() {
            document.getElementById('auth-options').classList.remove('hidden');
            document.getElementById('email-login-form').classList.add('hidden');
            document.getElementById('email-register-form').classList.add('hidden');
            document.getElementById('email-verify-form').classList.add('hidden');
        }
        
        function showEmailLogin() {
            document.getElementById('auth-options').classList.add('hidden');
            document.getElementById('email-login-form').classList.remove('hidden');
            document.getElementById('email-register-form').classList.add('hidden');
            document.getElementById('email-verify-form').classList.add('hidden');
        }
        
        function showEmailRegister() {
            document.getElementById('auth-options').classList.add('hidden');
            document.getElementById('email-login-form').classList.add('hidden');
            document.getElementById('email-register-form').classList.remove('hidden');
            document.getElementById('email-verify-form').classList.add('hidden');
        }
        
        function showEmailVerify() {
            document.getElementById('auth-options').classList.add('hidden');
            document.getElementById('email-login-form').classList.add('hidden');
            document.getElementById('email-register-form').classList.add('hidden');
            document.getElementById('email-verify-form').classList.remove('hidden');
        }
        
        function playAsGuest() {
            currentUser = {
                userId: 'guest_' + Date.now(),
                username: 'Guest Player',
                email: null,
                isGuest: true
            };
            document.getElementById('player-name').textContent = currentUser.username;
            document.getElementById('player-name-mode').textContent = currentUser.username;
            showScreen('mode-screen');
        }
        
        async function verifyEmail() {
            const verificationCode = document.getElementById('verify-code').value.trim();
            
            if (!verificationCode) {
                alert('Please enter the verification code');
                return;
            }
            
            if (!window.pendingUser) {
                alert('No pending verification. Please sign up again.');
                showEmailRegister();
                return;
            }
            
            try {
                const userPool = new AmazonCognitoIdentity.CognitoUserPool({
                    UserPoolId: COGNITO_CONFIG.userPoolId,
                    ClientId: COGNITO_CONFIG.clientId
                });
                
                const userData = {
                    Username: window.pendingUser.username,
                    Pool: userPool
                };
                
                const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
                
                cognitoUser.confirmRegistration(verificationCode, true, (err, result) => {
                    if (err) {
                        console.error('Verification failed:', err);
                        alert('Verification failed: ' + err.message);
                        return;
                    }
                    
                    alert('Email verified successfully! You can now sign in with your email.');
                    // Pre-fill the email in login form
                    document.getElementById('login-email').value = window.pendingUser.email || window.pendingUser.username;
                    window.pendingUser = null;
                    showEmailLogin();
                });
            } catch (error) {
                console.error('Verification error:', error);
                alert('Verification failed. Please try again.');
            }
        }
        
        async function resendVerificationCode() {
            if (!window.pendingUser) {
                alert('No pending verification. Please sign up again.');
                showEmailRegister();
                return;
            }
            
            try {
                const userPool = new AmazonCognitoIdentity.CognitoUserPool({
                    UserPoolId: COGNITO_CONFIG.userPoolId,
                    ClientId: COGNITO_CONFIG.clientId
                });
                
                const userData = {
                    Username: window.pendingUser.username,
                    Pool: userPool
                };
                
                const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
                
                cognitoUser.resendConfirmationCode((err, result) => {
                    if (err) {
                        console.error('Resend failed:', err);
                        alert('Failed to resend code: ' + err.message);
                        return;
                    }
                    
                    alert('Verification code resent! Please check your email.');
                });
            } catch (error) {
                console.error('Resend error:', error);
                alert('Failed to resend code. Please try again.');
            }
        }
        
        async function signInWithEmail() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            try {
                const authenticationData = {
                    Username: email,
                    Password: password
                };
                
                const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
                const userPool = new AmazonCognitoIdentity.CognitoUserPool({
                    UserPoolId: COGNITO_CONFIG.userPoolId,
                    ClientId: COGNITO_CONFIG.clientId
                });
                
                const userData = {
                    Username: email,
                    Pool: userPool
                };
                
                const cognitoUserInstance = new AmazonCognitoIdentity.CognitoUser(userData);
                cognitoUser = cognitoUserInstance;
                
                cognitoUserInstance.authenticateUser(authenticationDetails, {
                    onSuccess: async (result) => {
                        console.log('Cognito authentication successful');
                        await handleCognitoSuccess(result);
                    },
                    onFailure: (err) => {
                        console.error('Sign-in failed:', err);
                        if (err.code === 'UserNotConfirmedException') {
                            alert('Please verify your email address first. Check your email for the verification code.');
                            // Store user info for verification
                            window.pendingUser = {
                                username: email, // Use email as username for verification
                                email: email
                            };
                            showEmailVerify();
                        } else if (err.code === 'NotAuthorizedException') {
                            alert('Invalid email or password. Please try again.');
                        } else {
                            alert('Sign-in failed: ' + err.message);
                        }
                    }
                });
            } catch (error) {
                console.error('Sign-in error:', error);
                alert('Sign-in failed. Please try again.');
            }
        }
        
        async function signUpWithEmail() {
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            const displayName = document.getElementById('reg-username').value.trim();
            
            if (!email || !password || !displayName) {
                alert('Please fill in all fields');
                return;
            }
            
            if (password.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }
            
            try {
                const userPool = new AmazonCognitoIdentity.CognitoUserPool({
                    UserPoolId: COGNITO_CONFIG.userPoolId,
                    ClientId: COGNITO_CONFIG.clientId
                });
                
                // Generate unique username (not email format)
                const uniqueUsername = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                
                const attributeList = [
                    new AmazonCognitoIdentity.CognitoUserAttribute({
                        Name: 'email',
                        Value: email
                    }),
                    new AmazonCognitoIdentity.CognitoUserAttribute({
                        Name: 'preferred_username',
                        Value: displayName
                    })
                ];
                
                userPool.signUp(uniqueUsername, password, attributeList, null, (err, result) => {
                    if (err) {
                        console.error('Sign-up failed:', err);
                        alert('Sign-up failed: ' + err.message);
                        return;
                    }
                    
                    // Store user info for verification
                    window.pendingUser = {
                        username: uniqueUsername,
                        email: email,
                        displayName: displayName
                    };
                    
                    alert('Account created! Please check your email for verification code.');
                    showEmailVerify();
                });
            } catch (error) {
                console.error('Sign-up error:', error);
                alert('Sign-up failed. Please try again.');
            }
        }
        
        async function handleCognitoSuccess(result) {
            try {
                console.log('Cognito authentication successful');
                const accessToken = result.getAccessToken().getJwtToken();
                const idToken = result.getIdToken().getJwtToken();
                const payload = result.getIdToken().payload;
                
                // Extract user info from ID token
                const cognitoUserId = payload.sub;
                const email = payload.email;
                const preferredUsername = payload.preferred_username || payload.email;
                
                console.log('User info:', { cognitoUserId, email, preferredUsername });
                
                // Create user object
                currentUser = {
                    userId: cognitoUserId,
                    username: preferredUsername,
                    email: email
                };
                
                // Store tokens and user info
                localStorage.setItem('rpsUser', JSON.stringify(currentUser));
                localStorage.setItem('cognitoTokens', JSON.stringify({ accessToken, idToken }));
                
                // Update UI
                document.getElementById('player-name').textContent = currentUser.username;
                document.getElementById('player-name-mode').textContent = currentUser.username;
                showScreen('mode-screen');
                
                // Create user in backend if needed
                await createUserInBackend(currentUser);
                await loadUserStats();
            } catch (error) {
                console.error('Authentication error details:', error);
                alert('Authentication failed: ' + error.message);
            }
        }
        
        async function createUserInBackend(user) {
            try {
                const response = await fetch(`${API_URL}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'create_user', 
                        userId: user.userId,
                        username: user.username,
                        email: user.email
                    })
                });
                
                const data = await response.json();
                console.log('Backend user creation response:', data);
            } catch (error) {
                console.error('Backend user creation error:', error);
                // Don't fail authentication if backend user creation fails
            }
        }

        async function makeMove(move) {
            if (gameMode === 'multiplayer' && currentGameId) {
                // Real multiplayer move
                try {
                    const response = await fetch(`${API_URL}/game`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'play',
                            move: move,
                            userId: currentUser?.userId,
                            gameMode: 'multiplayer',
                            gameId: currentGameId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        if (data.data.timeout) {
                            // Game timed out
                            alert(data.data.message || 'Game was terminated due to time limit (1 minute)');
                            window.location.reload();
                        } else if (data.data.gameComplete) {
                            // Game completed immediately (both moves made)
                            showResult(data.data);
                            currentGameId = null;
                            await loadUserStats();
                        } else {
                            // Waiting for opponent's move
                            document.getElementById('game-screen').innerHTML = `
                                <h2>Move Sent!</h2>
                                <p>You played: ${getMoveEmoji(move)}</p>
                                <p>Waiting for opponent...</p>
                                <div class="spinner"></div>
                            `;
                            
                            // Start checking for game completion
                            gameCheckInterval = setInterval(checkGameStatus, 2000);
                        }
                    } else {
                        alert('Game error: ' + data.error);
                    }
                } catch (error) {
                    console.error('Multiplayer game error:', error);
                    alert('Connection error. Try again.');
                }
            } else {
                // Computer game
                try {
                    const response = await fetch(`${API_URL}/game`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'play',
                            move: move,
                            userId: currentUser?.userId,
                            gameMode: 'computer'
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        showResult(data.data);
                        await loadUserStats();
                    } else {
                        alert('Game error: ' + data.error);
                    }
                } catch (error) {
                    console.error('API Error:', error);
                    simulateGame(move);
                }
            }
        }

        function simulateGame(playerMove) {
            const moves = ['rock', 'paper', 'scissors'];
            const opponentMove = moves[Math.floor(Math.random() * 3)];
            const result = determineWinner(playerMove, opponentMove);
            
            showResult({
                yourMove: playerMove,
                opponentMove: opponentMove,
                result: result,
                opponent: 'Computer'
            });
        }

        function determineWinner(move1, move2) {
            if (move1 === move2) return 'draw';
            
            const winConditions = {
                rock: 'scissors',
                paper: 'rock',
                scissors: 'paper'
            };
            
            return winConditions[move1] === move2 ? 'win' : 'lose';
        }

        function showResult(gameResult) {
            const { yourMove, opponentMove, result, opponent } = gameResult;
            
            document.getElementById('your-move').textContent = getMoveEmoji(yourMove);
            document.getElementById('opponent-move').textContent = getMoveEmoji(opponentMove);
            
            const resultTitle = document.getElementById('result-title');
            if (result === 'win') {
                resultTitle.textContent = 'üéâ You Win!';
                resultTitle.style.color = '#28a745';
                playSound('win');
                gameStats.wins++;
            } else if (result === 'lose') {
                resultTitle.textContent = 'üòî You Lose!';
                resultTitle.style.color = '#dc3545';
                playSound('lose');
                gameStats.losses++;
            } else {
                resultTitle.textContent = 'ü§ù It\'s a Draw!';
                resultTitle.style.color = '#ffc107';
                gameStats.draws++;
            }
            
            gameStats.totalGames++;
            
            // Add rematch button for multiplayer games
            const resultScreen = document.getElementById('result-screen');
            const existingRematch = document.getElementById('rematch-btn');
            if (existingRematch) existingRematch.remove();
            
            if (gameMode === 'multiplayer' && opponent && !opponent.startsWith('Computer_')) {
                const rematchBtn = document.createElement('button');
                rematchBtn.id = 'rematch-btn';
                rematchBtn.className = 'primary-btn';
                rematchBtn.textContent = 'Rematch';
                rematchBtn.onclick = () => requestRematch(opponent);
                
                const playAgainBtn = resultScreen.querySelector('button');
                playAgainBtn.parentNode.insertBefore(rematchBtn, playAgainBtn);
            }
            
            showScreen('result-screen');
        }

        function getMoveEmoji(move) {
            const emojis = {
                rock: 'ü™® Rock',
                paper: 'üìÑ Paper',
                scissors: '‚úÇÔ∏è Scissors'
            };
            return emojis[move] || move;
        }

        function selectMode(mode) {
            gameMode = mode;
            
            if (mode === 'multiplayer') {
                findOnlinePlayer();
            } else {
                document.getElementById('opponent-info').textContent = 'vs Computer';
                playSound('bell');
                showScreen('game-screen');
            }
        }
        
        async function checkGameStatus() {
            if (!currentGameId) return;
            
            try {
                const response = await fetch(`${API_URL}/game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'check_game',
                        gameId: currentGameId,
                        userId: currentUser?.userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.gameComplete) {
                        clearInterval(gameCheckInterval);
                        
                        if (data.data.timeout) {
                            // Game timed out
                            alert(data.data.message || 'Game was terminated due to time limit (1 minute)');
                            window.location.reload();
                        } else {
                            // Game completed normally
                            showResult(data.data);
                            currentGameId = null;
                            await loadUserStats();
                        }
                    }
                }
            } catch (error) {
                console.error('Game check error:', error);
            }
        }
        
        function playSound(type) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === 'bell') {
                // Boxing bell sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            } else if (type === 'win') {
                // Victory sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.4);
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            } else if (type === 'lose') {
                // Defeat sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            }
        }
        
        async function findOnlinePlayer() {
            showScreen('waiting-screen');
            
            // Clear any existing polling state
            if (window.matchPolling) {
                clearTimeout(window.matchPolling);
                window.matchPolling = null;
            }
            
            const checkForMatch = async () => {
                try {
                    console.log('Checking for match...', currentUser?.userId);
                    
                    // Cache busting without CORS-triggering headers
                    const response = await fetch(`${API_URL}/game?_=${Date.now()}`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'find_match',
                            userId: currentUser?.userId,
                            username: currentUser?.username
                        })
                    });
                    
                    const data = await response.json();
                    console.log('Match response:', data);
                    
                    if (data.success && data.data.matchFound) {
                        console.log('Match found!', data.data);
                        currentGameId = data.data.gameId;
                        document.getElementById('opponent-info').textContent = 'vs ' + data.data.opponent;
                        
                        // Direct approach for Chrome compatibility
                        playSound('bell');
                        showScreen('game-screen');
                        
                        // Universal fallback for all browsers
                        setTimeout(() => {
                            if (document.getElementById('waiting-screen').classList.contains('hidden') === false) {
                                console.log('Fallback: forcing game screen transition');
                                showScreen('game-screen');
                            }
                        }, 200);
                        
                        // Clear polling immediately
                        if (window.matchPolling) {
                            clearTimeout(window.matchPolling);
                            window.matchPolling = null;
                        }
                        return; // Stop checking once match is found
                    } else {
                        console.log('No match yet, continuing to poll...');
                        window.matchPolling = setTimeout(checkForMatch, 250);
                    }
                } catch (error) {
                    console.error('Match check error:', error);
                    window.matchPolling = setTimeout(checkForMatch, 250);
                }
            };
            
            // Start checking immediately
            checkForMatch();
        }
        
        async function checkForMatch() {
            try {
                const response = await fetch(`${API_URL}/game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'find_match',
                        userId: currentUser?.userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.matchFound) {
                    document.getElementById('opponent-info').textContent = 'vs ' + data.data.opponent;
                    showScreen('game-screen');
                } else {
                    // Still waiting, timeout after 10 seconds total
                    searchTimeout = setTimeout(() => {
                        alert('No online players found. Playing against computer instead.');
                        gameMode = 'computer';
                        document.getElementById('opponent-info').textContent = 'vs Computer';
                        showScreen('game-screen');
                    }, 8000);
                }
            } catch (error) {
                gameMode = 'computer';
                document.getElementById('opponent-info').textContent = 'vs Computer';
                showScreen('game-screen');
            }
        }
        
        function cancelToMenu() {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
                searchTimeout = null;
            }
            if (window.matchPolling) {
                clearTimeout(window.matchPolling);
                window.matchPolling = null;
            }
            showScreen('mode-screen');
        }
        
        function playComputer() {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
                searchTimeout = null;
            }
            if (window.matchPolling) {
                clearTimeout(window.matchPolling);
                window.matchPolling = null;
            }
            gameMode = 'computer';
            document.getElementById('opponent-info').textContent = 'vs Computer';
            showScreen('game-screen');
        }
        

        
        async function requestRematch(opponent) {
            try {
                const response = await fetch(`${API_URL}/game`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'request_rematch',
                        userId: currentUser?.userId,
                        username: currentUser?.username,
                        opponent: opponent
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.data.gameId) {
                    currentGameId = data.data.gameId;
                    
                    // Reset game screen to fresh state
                    document.getElementById('game-screen').innerHTML = `
                        <h2>Make Your Move!</h2>
                        <p>Playing as: <span id="player-name">${currentUser?.username || 'Player'}</span></p>
                        <p id="opponent-info">vs ${opponent}</p>
                        <div>
                            <button class="move-btn" onclick="makeMove('rock')">ü™® Rock</button>
                            <button class="move-btn" onclick="makeMove('paper')">üìÑ Paper</button>
                            <button class="move-btn" onclick="makeMove('scissors')">‚úÇÔ∏è Scissors</button>
                        </div>
                    `;
                    
                    showScreen('game-screen');
                } else {
                    alert('Failed to start rematch: ' + (data.error || 'Opponent may not be available'));
                }
            } catch (error) {
                console.error('Rematch error:', error);
                alert('Failed to start rematch. Please try again.');
            }
        }
        
        function playAgain() {
            // Force page reload for repeat matchmaking to ensure clean state
            if (gameStats.totalGames > 0) {
                console.log('Reloading page for clean repeat matchmaking state');
                window.location.reload();
            } else {
                showScreen('mode-screen');
            }
        }

        async function loadUserStats() {
            if (!currentUser?.userId || currentUser.isGuest) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/stats/${currentUser.userId}`);
                const data = await response.json();
                
                if (data.success) {
                    gameStats = data.data;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }
        
        function showStats() {
            document.getElementById('total-games').textContent = gameStats.totalGames || 0;
            document.getElementById('wins').textContent = gameStats.wins || 0;
            document.getElementById('losses').textContent = gameStats.losses || 0;
            document.getElementById('draws').textContent = gameStats.draws || 0;
            showScreen('stats-screen');
        }
        
        async function showGameHistory() {
            if (!currentUser?.userId || currentUser.userId.startsWith('offline_')) {
                alert('Game history requires user registration');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/games/${currentUser.userId}`);
                const data = await response.json();
                
                const historyDiv = document.getElementById('game-history');
                
                if (data.success && data.data.length > 0) {
                    historyDiv.innerHTML = data.data.map(game => `
                        <div class="stat" style="margin-bottom: 1rem;">
                            <div><strong>vs ${game.opponent}</strong></div>
                            <div>${getMoveEmoji(game.yourMove)} vs ${getMoveEmoji(game.opponentMove)}</div>
                            <div style="color: ${game.result === 'win' ? '#28a745' : game.result === 'lose' ? '#dc3545' : '#ffc107'}">
                                ${game.result.toUpperCase()}
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${new Date(game.date).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = '<p>No games played yet!</p>';
                }
                
                showScreen('history-screen');
            } catch (error) {
                alert('Failed to load game history');
            }
        }
        
        async function showLeaderboard() {
            try {
                const url = currentUser?.userId ? `${API_URL}/leaderboard?userId=${currentUser.userId}` : `${API_URL}/leaderboard`;
                const response = await fetch(url);
                const data = await response.json();
                
                const leaderboardDiv = document.getElementById('leaderboard-list');
                
                if (data.success) {
                    let html = '';
                    const top10 = data.data.slice(0, 10);
                    const userEntry = data.data.find(p => p.rank > 10);
                    
                    // Show top 10
                    html += top10.map(player => `
                        <div class="stat" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;${player.userId === currentUser?.userId ? ' background: #e3f2fd;' : ''}">
                            <span><strong>#${player.rank} ${player.username}</strong></span>
                            <span>${player.wins || 0} wins (${player.winRate || 0}%)</span>
                        </div>
                    `).join('');
                    
                    // Add separator and user's rank if not in top 10
                    if (userEntry) {
                        html += '<div style="margin: 1rem 0; text-align: center; color: #666;">...</div>';
                        html += `
                            <div class="stat" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; background: #e3f2fd;">
                                <span><strong>#${userEntry.rank} ${userEntry.username} (You)</strong></span>
                                <span>${userEntry.wins || 0} wins (${userEntry.winRate || 0}%)</span>
                            </div>
                        `;
                    }
                    
                    leaderboardDiv.innerHTML = html;
                } else {
                    leaderboardDiv.innerHTML = '<p>Failed to load leaderboard</p>';
                }
                
                showScreen('leaderboard-screen');
            } catch (error) {
                alert('Failed to load leaderboard');
            }
        }

        function backToGame() {
            showScreen('mode-screen');
        }
        
        function logout() {
            // Sign out from Cognito if not a guest
            if (currentUser && !currentUser.isGuest && cognitoUser) {
                cognitoUser.signOut();
            }
            
            // Clear user data
            currentUser = null;
            cognitoUser = null;
            gameStats = { totalGames: 0, wins: 0, losses: 0, draws: 0 };
            gameMode = 'computer';
            currentGameId = null;
            
            // Clear localStorage
            localStorage.removeItem('rpsUser');
            localStorage.removeItem('cognitoTokens');
            
            // Clear intervals
            if (gameCheckInterval) {
                clearInterval(gameCheckInterval);
                gameCheckInterval = null;
            }
            
            // Cancel any ongoing search
            if (searchTimeout) {
                clearTimeout(searchTimeout);
                searchTimeout = null;
            }
            
            // Clear form fields
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('reg-email').value = '';
            document.getElementById('reg-password').value = '';
            document.getElementById('reg-username').value = '';
            
            // Show login screen
            showAuthOptions();
            showScreen('login-screen');
        }
    </script>
</body>
</html>
